name: Test Suite

on:
  push:
    branches: [ main, master, develop, 'feat/**' ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache-dependency-path: go.sum

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Run unit tests
        run: |
          go test -v -race -timeout 5m \
            -coverprofile=coverage-unit.out \
            -covermode=atomic \
            ./api/... \
            ./app/... \
            ./channel/... \
            ./connection/... \
            ./events/... \
            ./storage/... \
            ./utils/... \
            ./websockets/... \
            ./concurrency/...

      - name: Upload unit test coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: coverage-unit.out
          flags: unit-tests
          name: unit-tests-coverage

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache-dependency-path: go.sum

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Wait for Redis
        run: |
          until redis-cli -h localhost -p 6379 ping; do
            echo "Waiting for Redis..."
            sleep 2
          done

      - name: Run Redis integration tests
        env:
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          REDIS_DB: 0
        run: |
          go test -v -race -timeout 10m \
            -coverprofile=coverage-redis.out \
            -covermode=atomic \
            ./redis/...

      - name: Run integration tests
        env:
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          REDIS_DB: 0
        run: |
          go test -v -race -timeout 10m \
            -coverprofile=coverage-integration.out \
            -covermode=atomic \
            ./integration/...

      - name: Upload integration test coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: coverage-redis.out,coverage-integration.out
          flags: integration-tests
          name: integration-tests-coverage

  webhook-tests:
    name: Webhook Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache-dependency-path: go.sum

      - name: Download dependencies
        run: go mod download

      - name: Run webhook tests
        run: |
          go test -v -timeout 5m \
            -coverprofile=coverage-webhooks.out \
            -covermode=atomic \
            ./app/... -run TestTrigger

      - name: Upload webhook test coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: coverage-webhooks.out
          flags: webhook-tests
          name: webhook-tests-coverage

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, webhook-tests]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "All test jobs completed"
          echo "Unit tests: ${{ needs.unit-tests.result }}"
          echo "Integration tests: ${{ needs.integration-tests.result }}"
          echo "Webhook tests: ${{ needs.webhook-tests.result }}"

